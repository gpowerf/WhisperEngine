<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhisperEngine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #0a0a0a;
            color: #00ff41;
        }
        #game-container {
            max-width: 800px;
            margin: auto;
            border: 2px solid #00ff41;
            box-shadow: 0 0 15px #00ff41;
        }
        #output {
            height: 40vh;
            overflow-y: auto;
            padding: 1rem;
            border-bottom: 2px solid #00ff41;
            scrollbar-width: thin;
            scrollbar-color: #00ff41 #0a0a0a;
        }
        #inventory-display {
            overflow-y: auto;
            padding: 1rem;
            border-bottom: 2px solid #00ff41;
            scrollbar-width: thin;
            scrollbar-color: #00ff41 #0a0a0a;
        }
        #output::-webkit-scrollbar, #inventory-display::-webkit-scrollbar {
            width: 8px;
        }
        #output::-webkit-scrollbar-track, #inventory-display::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        #output::-webkit-scrollbar-thumb, #inventory-display::-webkit-scrollbar-thumb {
            background-color: #00ff41;
            border-radius: 4px;
        }
        #input-form {
            display: flex;
            border-top: 2px solid #00ff41;
        }
        #command-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: #00ff41;
            padding: 0.5rem 1rem;
            outline: none;
        }
        #command-input::placeholder {
            color: #008f25;
        }
        #prompt {
            padding: 0.5rem 0 0.5rem 1rem;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .header {
            background-color: #00ff41;
            color: #0a0a0a;
            padding: 0.25rem 1rem;
            text-align: center;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="game-container" class="bg-black rounded-lg overflow-hidden">
        <!-- Game Title Header -->
        <div id="game-title" class="header">
            <!-- Title will be inserted by JS -->
        </div>

        <!-- Game Output -->
        <div id="output"></div>

        <!-- Inventory Display -->
        <div class="header">
            INVENTORY
        </div>
        <div id="inventory-display" class="h-40"></div>

        <!-- Input Form -->
        <form id="input-form" class="bg-black">
            <span id="prompt">&gt;</span>
            <input type="text" id="command-input" placeholder="Type your command..." autocomplete="off">
        </form>
    </div>

    <script src="game-data-adventureland.js"></script>
    <script>
        // --- DOM ELEMENTS ---
        const output = document.getElementById('output');
        const inventoryDisplay = document.getElementById('inventory-display');
        const inputForm = document.getElementById('input-form');
        const commandInput = document.getElementById('command-input');

        // --- GAME STATE ---
        let player = {
            currentRoom: null, // Will be set by the game data
            inventory: []
        };
        let isIntroScreen = true;

        // --- GAME LOGIC ---

        function addTextToDisplay(text) {
            const p = document.createElement('p');
            p.innerHTML = text.replace(/\n/g, '<br>'); // Support newlines
            output.appendChild(p);
            output.scrollTop = output.scrollHeight; // Auto-scroll
        }

        function updateInventoryDisplay() {
            inventoryDisplay.innerHTML = '';
            if (player.inventory.length === 0) {
                inventoryDisplay.innerHTML = '<p class="text-gray-500">You are carrying nothing.</p>';
            } else {
                player.inventory.forEach(item => {
                    const itemEl = document.createElement('p');
                    itemEl.textContent = item.name;
                    inventoryDisplay.appendChild(itemEl);
                });
            }
        }

        function renderRoom() {
            const room = rooms[player.currentRoom];
            let html = `<h2 class="text-xl text-green-300 mb-2">${room.name}</h2>`;
            html += `<p>${room.description()}</p>`;

            // List items in the room
            if (room.items.length > 0) {
                html += '<p class="mt-4">You see here: ';
                html += room.items.map(i => i.name).join(', ') + '.</p>';
            }

            // List exits
            const availableExits = Object.keys(room.exits);
            if (availableExits.length > 0) {
                html += `<p class="mt-2">Exits are: ${availableExits.join(', ')}.</p>`;
            }
            addTextToDisplay(html);
        }

        function handleCommand(command) {
            const parts = command.toLowerCase().split(' ').filter(p => p !== '');
            const verb = parts[0];
            const noun = parts.slice(1).join(' ');

            if (!verb) {
                return;
            }

            switch (verb) {
                case 'go':
                case 'move':
                    handleGo(noun);
                    break;
                case 'look':
                case 'examine':
                    handleLook(noun);
                    break;
                case 'take':
                case 'get':
                    handleTake(noun);
                    break;
                case 'give':
                    handleGive(noun);
                    break;
                case 'drop':
                    handleDrop(noun);
                    break;
                case 'i':
                case 'inventory':
                    showInventory();
                    break;
                case 'light': // Alias for 'use'
                case 'use':
                    handleUse(noun);
                    break;
                case 'read':
                    handleRead(noun);
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'goal':
                case 'score':
                    showScore();
                    break;
                default:
                    handleRoomAction(verb, noun);
            }
        }

        function handleGo(direction) {
            const currentRoom = rooms[player.currentRoom];
            if (currentRoom.specialAction && currentRoom.specialAction('go', direction)) {
                return; // The room's special action handled the move (e.g., troll blocking).
            }
            const room = rooms[player.currentRoom];
            if (room.exits[direction]) {
                // Check if the exit is locked
                if (room.locked && room.locked[direction] && room.locked[direction].isLocked) {
                    addTextToDisplay(room.locked[direction].message);
                    return;
                }
                const nextRoomId = room.exits[direction];
                player.currentRoom = nextRoomId;
                const nextRoom = rooms[nextRoomId];
                if (nextRoom.onEnter) {
                    nextRoom.onEnter();
                }
                renderRoom();
            } else {
                addTextToDisplay("You can't go that way.");
            }
        }

        function handleLook(noun) {
            const currentRoom = rooms[player.currentRoom];
            // Let a room's special action override the default look behavior.
            if (noun && currentRoom.specialAction && currentRoom.specialAction('look', noun)) {
                return;
            }

            if (!noun || noun === 'around' || noun === 'room') {
                renderRoom();
                return;
            }

            // Look at item in inventory
            const itemInInventory = player.inventory.find(i => i.name.toLowerCase().includes(noun));
            if (itemInInventory) {
                addTextToDisplay(itemInInventory.description);
                return;
            }

            // Look at item in room
            const itemInRoom = rooms[player.currentRoom].items.find(i => i.name.toLowerCase().includes(noun));
            if (itemInRoom) {
                addTextToDisplay(itemInRoom.description);
                return;
            }

            addTextToDisplay("You don't see that here.");
        }

        function handleTake(noun) {
            if (!noun) {
                addTextToDisplay("Take what?");
                return;
            }
            const room = rooms[player.currentRoom];
            const itemIndex = room.items.findIndex(i => i.name.toLowerCase().includes(noun));

            if (itemIndex !== -1) {
                const itemTemplate = room.items[itemIndex];

                // New Feature: Check if the room has a special condition for taking this item.
                if (room.canTakeItemCheck && !room.canTakeItemCheck(itemTemplate)) {
                    return; // The custom check failed and printed its own message.
                }

                if (itemTemplate.takeable) {
                    // Create a clone of the item so we don't mutate the original template
                    const itemCopy = { ...itemTemplate };
                    player.inventory.push(itemCopy);
                    room.items.splice(itemIndex, 1);
                    addTextToDisplay(`You take the ${itemCopy.name}.`);
                    updateInventoryDisplay();
                    // Check for a special onTake action
                    if (itemCopy.onTake) itemCopy.onTake();

                } else {
                    addTextToDisplay("You can't take that.");
                }
            } else {
                addTextToDisplay("You don't see that here.");
            }
        }
        
        function handleGive(noun) {
            if (!noun) {
                addTextToDisplay("Give what?");
                return;
            }

            const itemIndex = player.inventory.findIndex(i => i.name.toLowerCase().includes(noun));
            if (itemIndex === -1) {
                addTextToDisplay("You don't have that to give.");
                return;
            }

            const item = player.inventory[itemIndex];
            const currentRoom = rooms[player.currentRoom];

            // Let the room's special action handle the logic. Pass the verb, noun, and the actual item object.
            if (currentRoom.specialAction && currentRoom.specialAction('give', noun, item)) {
                // The special action is responsible for the outcome, including removing the item.
            } else {
                addTextToDisplay("Nothing happens.");
            }
        }

        function handleDrop(noun) {
            if (!noun) {
                addTextToDisplay("Drop what?");
                return;
            }
            const itemIndex = player.inventory.findIndex(i => i.name.toLowerCase().includes(noun));
            if (itemIndex !== -1) {
                const item = player.inventory[itemIndex];
                rooms[player.currentRoom].items.push(item);
                player.inventory.splice(itemIndex, 1);
                addTextToDisplay(`You drop the ${item.name}.`);
                updateInventoryDisplay();
            } else {
                addTextToDisplay("You aren't carrying that.");
            }
        }

        function handleUse(noun) {
            if (!noun) {
                addTextToDisplay("Use what?");
                return;
            }
            const item = player.inventory.find(i => i.name.toLowerCase().includes(noun));
            if (!item) {
                addTextToDisplay("You don't have that.");
                return;
            }

            // Check if the item has a specific 'onUse' action
            if (item.onUse) {
                item.onUse(item); // Pass the item itself to the function
            } else {
                addTextToDisplay(`You can't figure out how to use the ${item.name}.`);
            }
        }
        
        function handleRead(noun) {
            if (!noun) {
                addTextToDisplay("Read what?");
                return;
            }

            const itemInRoom = rooms[player.currentRoom].items.find(i => i.name.toLowerCase().includes(noun));
            const itemInInventory = player.inventory.find(i => i.name.toLowerCase().includes(noun));

            const targetItem = itemInInventory || itemInRoom; // Prioritize inventory item

            if (!targetItem) {
                addTextToDisplay("You don't see that here.");
            } else if (targetItem.content) {
                addTextToDisplay(targetItem.content);
            } else {
                addTextToDisplay("There's nothing to read on the " + targetItem.name + ".");
            }
        }

        function handleRoomAction(verb, noun) {
            const currentRoom = rooms[player.currentRoom];
            // Let the room's special action handle the logic.
            if (currentRoom.specialAction && currentRoom.specialAction(verb, noun)) {
                // The special action is responsible for the outcome.
                return;
            }
            // Provide default feedback if the action wasn't handled by the room
            if (verb === 'say') {
                addTextToDisplay(`You say "${noun}" out loud. Nothing happens.`);
            } else if (['climb', 'jump', 'swim'].includes(verb)) { // Add other custom verbs here
                addTextToDisplay(`You can't ${verb} here.`);
            } else {
                addTextToDisplay("I don't understand that command. Try 'help'.");
            }
        }

        function showScore() {
            // Check if the game data file has defined treasures
            if (typeof treasures === 'undefined' || !Array.isArray(treasures)) {
                addTextToDisplay("This adventure doesn't seem to have a score or a specific goal.");
                return;
            }

            const foundTreasures = player.inventory.filter(i => treasures.includes(i.id)).length;
            const totalTreasures = treasures.length;

            let message = '';
            if (typeof gameGoal !== 'undefined' && gameGoal) {
                message += gameGoal + '<br>';
            }
            message += `You have found ${foundTreasures} of the ${totalTreasures} treasures.`;
            addTextToDisplay(message);
        }

        function showInventory() {
            if (player.inventory.length === 0) {
                addTextToDisplay('You are carrying nothing.');
            } else {
                let inventoryList = 'You are carrying:<br>' + player.inventory.map(i => `- ${i.name}`).join('<br>');
                addTextToDisplay(inventoryList);
            }
        }

        function showHelp() {
            addTextToDisplay(`--- Common Commands ---<br>
            <strong>go [direction]</strong> (e.g., go north)<br>
            <strong>look</strong> or <strong>examine [object]</strong><br>
            <strong>take [item]</strong><br>
            <strong>drop [item]</strong><br>
            <strong>use [item]</strong><br>
            <strong>read [item]</strong><br>
            <strong>climb [object]</strong><br>
            <strong>inventory</strong> (or <strong>i</strong>)<br>
            <strong>say [word]</strong><br>
            <strong>goal</strong> or <strong>score</strong><br>
            <strong>help</strong>`);
        }


        


        // --- INITIALIZATION ---
        inputForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const command = commandInput.value.trim();
            if (command) {
                addTextToDisplay(`<span class="text-gray-500">&gt; ${command}</span>`);
                handleCommand(command);
            }
            commandInput.value = '';
        });

        function beginAdventure() {
            isIntroScreen = false;
            output.innerHTML = ''; // Clear the intro text
            commandInput.disabled = false;

            player.currentRoom = startingRoom; // Set player's starting location from game data
            renderRoom();
            updateInventoryDisplay();
            commandInput.focus();
        }

        function startGame() {
            output.innerHTML = '';
            isIntroScreen = true;
            commandInput.disabled = true; // Disable input during intro

            // Set the title from the loaded game data file
            document.title = gameTitle;
            document.getElementById('game-title').textContent = gameTitle.toUpperCase();

            // Display intro text if it exists in the game data
            if (typeof gameIntro !== 'undefined' && gameIntro) {
                addTextToDisplay(gameIntro);
            }

            // Add the prompt to continue
            addTextToDisplay("<br><p class='text-center animate-pulse'>Press any key to begin...</p>");
            output.scrollTop = 0; // Ensure the intro text starts at the top

            // Listen for the first interaction to start the game
            document.addEventListener('keydown', beginAdventure, { once: true });
            document.addEventListener('click', beginAdventure, { once: true });
        }

        // Start the game on load
        window.onload = startGame;

    </script>
</body>
</html>
